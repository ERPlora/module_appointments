{% extends "ui/app_base.html" %}
{% load static i18n djicons ui component_tags %}

{% block page_title %}{% trans "Block Time" %}{% endblock %}

{% block page_content %}
{% ui_page_header title=_("Block Time Period") %}

<div class="ion-padding">
    {% ui_card %}
        <form id="blockedForm" method="post">
            {% csrf_token %}

            <ion-item>
                <ion-input
                    label="{% trans 'Title' %} *"
                    label-placement="floating"
                    name="title"
                    placeholder="{% trans 'e.g., Holiday, Vacation, Maintenance' %}"
                    required>
                </ion-input>
            </ion-item>

            <ion-item class="mt-sm">
                <ion-select
                    label="{% trans 'Type' %}"
                    label-placement="floating"
                    name="block_type"
                    value="other">
                    {% for value, label in block_types %}
                    <ion-select-option value="{{ value }}">{{ label }}</ion-select-option>
                    {% endfor %}
                </ion-select>
            </ion-item>

            <div class="ui-grid ui-grid--2 mt-sm">
                <ion-item>
                    <ion-input
                        label="{% trans 'Start Date & Time' %} *"
                        label-placement="floating"
                        name="start_datetime"
                        type="datetime-local"
                        required>
                    </ion-input>
                </ion-item>

                <ion-item>
                    <ion-input
                        label="{% trans 'End Date & Time' %} *"
                        label-placement="floating"
                        name="end_datetime"
                        type="datetime-local"
                        required>
                    </ion-input>
                </ion-item>
            </div>

            <ion-item class="mt-sm">
                <ion-label>{% trans "All Day" %}</ion-label>
                <ion-toggle name="all_day" slot="end"></ion-toggle>
            </ion-item>

            <ion-item class="mt-sm">
                <ion-textarea
                    label="{% trans 'Reason' %}"
                    label-placement="floating"
                    name="reason"
                    rows="3"
                    placeholder="{% trans 'Optional reason for blocking this time' %}">
                </ion-textarea>
            </ion-item>

            <div class="mt-lg">
                <ion-button type="submit" expand="block" id="submitBtn">
                    {% icon "close-circle-outline" %}
                    {% trans "Block Time" %}
                </ion-button>
            </div>
        </form>
    {% endui_card %}
</div>

<script>
document.getElementById('blockedForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    const form = e.target;
    const submitBtn = document.getElementById('submitBtn');
    submitBtn.disabled = true;

    const formData = new FormData(form);
    const data = {
        title: formData.get('title'),
        block_type: formData.get('block_type'),
        start_datetime: formData.get('start_datetime'),
        end_datetime: formData.get('end_datetime'),
        all_day: form.querySelector('[name="all_day"]').checked,
        reason: formData.get('reason')
    };

    try {
        const response = await fetch('{% url "appointments:blocked_time_create" %}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });

        const result = await response.json();

        if (result.success) {
            Alpine.store('ui').success('{% trans "Time blocked successfully" %}');
            window.location.href = '/modules/appointments/blocked/';
        } else {
            Alpine.store('ui').error(result.error || '{% trans "Error blocking time" %}');
            submitBtn.disabled = false;
        }
    } catch (error) {
        console.error('Error:', error);
        Alpine.store('ui').error('{% trans "Error blocking time" %}');
        submitBtn.disabled = false;
    }
});
</script>

{% component "tabbar" module_id="appointments" current_view="calendar" %}{% endcomponent %}
{% endblock %}
