{% extends "ui/module_content.html" %}
{% load static i18n djicons ui %}

{% block header_actions %}
<ion-button size="default" fill="outline" href="{% url 'appointments:blocked_times_list' %}" title="{% trans 'Blocked Times' %}">
    {% icon "close-circle-outline" %}
</ion-button>

<ion-button size="default" href="{% url 'appointments:appointment_create' %}" title="{% trans 'New Appointment' %}">
    {% icon "add-outline" %}
</ion-button>
{% endblock %}

{% block content %}
<style>
.calendar-container {
    background: var(--ion-card-background);
    border-radius: 12px;
    padding: 1rem;
    min-height: 600px;
}

.calendar-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid var(--border-color);
}

.calendar-nav {
    display: flex;
    gap: 0.5rem;
    align-items: center;
}

.calendar-title {
    font-size: 1.25rem;
    font-weight: 600;
}

.calendar-grid {
    display: grid;
    grid-template-columns: 60px repeat(7, 1fr);
    gap: 1px;
    background: var(--border-color);
    border-radius: 8px;
    overflow: hidden;
}

.calendar-cell {
    background: var(--ion-card-background);
    padding: 0.5rem;
    min-height: 80px;
}

.calendar-header-cell {
    background: var(--bg-color-secondary);
    padding: 0.5rem;
    text-align: center;
    font-weight: 600;
    font-size: 0.875rem;
}

.calendar-time-cell {
    background: var(--bg-color-secondary);
    padding: 0.25rem;
    text-align: right;
    font-size: 0.75rem;
    color: var(--text-color-secondary);
}

.calendar-event {
    background: var(--ion-color-primary);
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.75rem;
    margin-bottom: 2px;
    cursor: pointer;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.calendar-event--pending { background: var(--ion-color-warning); color: var(--ion-color-warning-contrast); }
.calendar-event--confirmed { background: var(--ion-color-primary); }
.calendar-event--in_progress { background: var(--ion-color-tertiary); }
.calendar-event--completed { background: var(--ion-color-success); }
.calendar-event--cancelled { background: var(--ion-color-medium); }
.calendar-event--no_show { background: var(--ion-color-danger); }

.day-view-container {
    display: grid;
    grid-template-columns: 60px 1fr;
    gap: 1px;
}

.time-slot {
    display: flex;
    border-bottom: 1px solid var(--border-color);
    min-height: 60px;
}

.time-label {
    width: 60px;
    padding: 0.25rem;
    text-align: right;
    font-size: 0.75rem;
    color: var(--text-color-secondary);
    background: var(--bg-color-secondary);
}

.slot-content {
    flex: 1;
    padding: 0.25rem;
    position: relative;
}
</style>

<div class="calendar-container" x-data="calendarApp()">
    <div class="calendar-header">
        <div class="calendar-nav">
            <ion-button fill="clear" size="small" @click="prevPeriod">
                {% icon "chevron-back-outline" %}
            </ion-button>
            <span class="calendar-title" x-text="currentTitle"></span>
            <ion-button fill="clear" size="small" @click="nextPeriod">
                {% icon "chevron-forward-outline" %}
            </ion-button>
        </div>
        <div class="d-flex gap-sm">
            <ion-button fill="clear" size="small" @click="goToToday">{% trans "Today" %}</ion-button>
            <ion-segment :value="viewMode" @ionChange="viewMode = $event.detail.value">
                <ion-segment-button value="day">
                    <ion-label>{% trans "Day" %}</ion-label>
                </ion-segment-button>
                <ion-segment-button value="week">
                    <ion-label>{% trans "Week" %}</ion-label>
                </ion-segment-button>
            </ion-segment>
        </div>
    </div>

    <template x-if="viewMode === 'day'">
        <div class="day-view-container">
            <template x-for="hour in hours" :key="hour">
                <div class="time-slot">
                    <div class="time-label" x-text="formatHour(hour)"></div>
                    <div class="slot-content">
                        <template x-for="event in getEventsForHour(hour)" :key="event.id">
                            <div class="calendar-event" :class="'calendar-event--' + event.extendedProps.status"
                                 @click="openAppointment(event.id)"
                                 x-text="event.title">
                            </div>
                        </template>
                    </div>
                </div>
            </template>
        </div>
    </template>

    <template x-if="viewMode === 'week'">
        <div class="calendar-grid">
            <div class="calendar-header-cell"></div>
            <template x-for="day in weekDays" :key="day.date">
                <div class="calendar-header-cell">
                    <div x-text="day.name"></div>
                    <div x-text="day.number"></div>
                </div>
            </template>
            <template x-for="hour in hours" :key="hour">
                <template x-for="(day, index) in [null, ...weekDays]" :key="index">
                    <template x-if="index === 0">
                        <div class="calendar-time-cell" x-text="formatHour(hour)"></div>
                    </template>
                    <template x-if="index > 0">
                        <div class="calendar-cell">
                            <template x-for="event in getEventsForDayHour(day.date, hour)" :key="event.id">
                                <div class="calendar-event" :class="'calendar-event--' + event.extendedProps.status"
                                     @click="openAppointment(event.id)"
                                     x-text="event.extendedProps.customer_name">
                                </div>
                            </template>
                        </div>
                    </template>
                </template>
            </template>
        </div>
    </template>
</div>

<script>
function calendarApp() {
    return {
        viewMode: 'day',
        currentDate: new Date(),
        events: [],
        hours: Array.from({length: {{ config.calendar_end_hour }} - {{ config.calendar_start_hour }}}, (_, i) => i + {{ config.calendar_start_hour }}),

        get currentTitle() {
            const options = this.viewMode === 'day'
                ? { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }
                : { year: 'numeric', month: 'long' };
            return this.currentDate.toLocaleDateString('{{ request.LANGUAGE_CODE }}', options);
        },

        get weekDays() {
            const days = [];
            const start = new Date(this.currentDate);
            start.setDate(start.getDate() - start.getDay() + 1);

            for (let i = 0; i < 7; i++) {
                const d = new Date(start);
                d.setDate(start.getDate() + i);
                days.push({
                    date: d.toISOString().split('T')[0],
                    name: d.toLocaleDateString('{{ request.LANGUAGE_CODE }}', { weekday: 'short' }),
                    number: d.getDate()
                });
            }
            return days;
        },

        init() {
            this.fetchEvents();
        },

        async fetchEvents() {
            const start = this.getStartDate();
            const end = this.getEndDate();
            const response = await fetch(`/modules/appointments/calendar/data/?start=${start}&end=${end}`);
            const data = await response.json();
            this.events = data.events;
        },

        getStartDate() {
            if (this.viewMode === 'day') {
                return this.currentDate.toISOString().split('T')[0];
            }
            const start = new Date(this.currentDate);
            start.setDate(start.getDate() - start.getDay() + 1);
            return start.toISOString().split('T')[0];
        },

        getEndDate() {
            if (this.viewMode === 'day') {
                return this.currentDate.toISOString().split('T')[0];
            }
            const end = new Date(this.currentDate);
            end.setDate(end.getDate() - end.getDay() + 7);
            return end.toISOString().split('T')[0];
        },

        formatHour(hour) {
            return `${hour.toString().padStart(2, '0')}:00`;
        },

        getEventsForHour(hour) {
            const dateStr = this.currentDate.toISOString().split('T')[0];
            return this.events.filter(e => {
                const eventDate = e.start.split('T')[0];
                const eventHour = parseInt(e.start.split('T')[1].split(':')[0]);
                return eventDate === dateStr && eventHour === hour;
            });
        },

        getEventsForDayHour(dateStr, hour) {
            return this.events.filter(e => {
                const eventDate = e.start.split('T')[0];
                const eventHour = parseInt(e.start.split('T')[1].split(':')[0]);
                return eventDate === dateStr && eventHour === hour;
            });
        },

        prevPeriod() {
            if (this.viewMode === 'day') {
                this.currentDate.setDate(this.currentDate.getDate() - 1);
            } else {
                this.currentDate.setDate(this.currentDate.getDate() - 7);
            }
            this.currentDate = new Date(this.currentDate);
            this.fetchEvents();
        },

        nextPeriod() {
            if (this.viewMode === 'day') {
                this.currentDate.setDate(this.currentDate.getDate() + 1);
            } else {
                this.currentDate.setDate(this.currentDate.getDate() + 7);
            }
            this.currentDate = new Date(this.currentDate);
            this.fetchEvents();
        },

        goToToday() {
            this.currentDate = new Date();
            this.fetchEvents();
        },

        openAppointment(id) {
            window.location.href = `/modules/appointments/appointments/${id}/`;
        }
    };
}
</script>
{% endblock %}
