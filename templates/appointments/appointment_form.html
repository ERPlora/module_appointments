{% extends "ui/app_base.html" %}
{% load static i18n djicons ui component_tags %}

{% block page_title %}
    {% if mode == 'create' %}{% trans "New Appointment" %}
    {% else %}{% trans "Edit Appointment" %}{% endif %}
{% endblock %}

{% block page_content %}
{% if mode == 'create' %}
{% ui_page_header title=_("New Appointment") %}
{% else %}
{% ui_page_header title=_("Edit Appointment") %}
{% endif %}

<div class="ion-padding">
    {% ui_card %}
        <form id="appointmentForm" method="post">
            {% csrf_token %}

            {# Customer Information #}
            <div class="fw-semibold mb-md">{% trans "Customer Information" %}</div>

            <ion-item>
                <ion-input
                    label="{% trans 'Customer Name' %} *"
                    label-placement="floating"
                    name="customer_name"
                    value="{% if appointment %}{{ appointment.customer_name }}{% endif %}"
                    placeholder="{% trans 'Enter customer name' %}"
                    required>
                </ion-input>
            </ion-item>

            <div class="ui-grid ui-grid--2 mt-sm">
                <ion-item>
                    <ion-input
                        label="{% trans 'Phone' %}"
                        label-placement="floating"
                        name="customer_phone"
                        type="tel"
                        value="{% if appointment %}{{ appointment.customer_phone }}{% endif %}"
                        placeholder="{% trans 'Phone number' %}">
                    </ion-input>
                </ion-item>

                <ion-item>
                    <ion-input
                        label="{% trans 'Email' %}"
                        label-placement="floating"
                        name="customer_email"
                        type="email"
                        value="{% if appointment %}{{ appointment.customer_email }}{% endif %}"
                        placeholder="{% trans 'Email address' %}">
                    </ion-input>
                </ion-item>
            </div>

            {# Service Information #}
            <div class="fw-semibold mb-md mt-lg">{% trans "Service" %}</div>

            <ion-item>
                <ion-input
                    label="{% trans 'Service Name' %} *"
                    label-placement="floating"
                    name="service_name"
                    value="{% if appointment %}{{ appointment.service_name }}{% endif %}"
                    placeholder="{% trans 'Enter service name' %}"
                    required>
                </ion-input>
            </ion-item>

            <div class="ui-grid ui-grid--2 mt-sm">
                <ion-item>
                    <ion-input
                        label="{% trans 'Price' %}"
                        label-placement="floating"
                        name="service_price"
                        type="number"
                        step="0.01"
                        min="0"
                        value="{% if appointment %}{{ appointment.service_price }}{% else %}0{% endif %}"
                        placeholder="0.00">
                    </ion-input>
                </ion-item>

                <ion-item>
                    <ion-input
                        label="{% trans 'Staff Name' %}"
                        label-placement="floating"
                        name="staff_name"
                        value="{% if appointment %}{{ appointment.staff_name }}{% endif %}"
                        placeholder="{% trans 'Assigned staff' %}">
                    </ion-input>
                </ion-item>
            </div>

            {# Date & Time #}
            <div class="fw-semibold mb-md mt-lg">{% trans "Date & Time" %}</div>

            <div class="ui-grid ui-grid--2">
                <ion-item>
                    <ion-input
                        label="{% trans 'Date & Time' %} *"
                        label-placement="floating"
                        name="start_datetime"
                        type="datetime-local"
                        value="{% if appointment %}{{ appointment.start_datetime|date:'Y-m-d' }}T{{ appointment.start_datetime|time:'H:i' }}{% endif %}"
                        required>
                    </ion-input>
                </ion-item>

                <ion-item>
                    <ion-input
                        label="{% trans 'Duration (minutes)' %} *"
                        label-placement="floating"
                        name="duration_minutes"
                        type="number"
                        min="15"
                        step="15"
                        value="{% if appointment %}{{ appointment.duration_minutes }}{% elif config %}{{ config.default_duration }}{% else %}60{% endif %}"
                        required>
                    </ion-input>
                </ion-item>
            </div>

            {# Notes #}
            <div class="fw-semibold mb-md mt-lg">{% trans "Notes" %}</div>

            <ion-item>
                <ion-textarea
                    label="{% trans 'Customer Notes' %}"
                    label-placement="floating"
                    name="notes"
                    rows="3"
                    placeholder="{% trans 'Notes visible to customer' %}">{% if appointment %}{{ appointment.notes }}{% endif %}</ion-textarea>
            </ion-item>

            {% if mode == 'edit' %}
            <ion-item class="mt-sm">
                <ion-textarea
                    label="{% trans 'Internal Notes' %}"
                    label-placement="floating"
                    name="internal_notes"
                    rows="3"
                    placeholder="{% trans 'Internal notes (not visible to customer)' %}">{% if appointment %}{{ appointment.internal_notes }}{% endif %}</ion-textarea>
            </ion-item>
            {% endif %}

            {# Submit Button #}
            <div class="mt-lg">
                <ion-button type="submit" expand="block" id="submitBtn">
                    {% icon "save-outline" %}
                    {% if mode == 'create' %}{% trans "Create Appointment" %}
                    {% else %}{% trans "Save Changes" %}{% endif %}
                </ion-button>
            </div>
        </form>
    {% endui_card %}
</div>

<script>
document.getElementById('appointmentForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    const form = e.target;
    const submitBtn = document.getElementById('submitBtn');
    submitBtn.disabled = true;

    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());

    try {
        const url = {% if mode == 'edit' %}'{% url "appointments:appointment_edit" appointment.id %}'{% else %}'{% url "appointments:appointment_create" %}'{% endif %};
        const response = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });

        const result = await response.json();

        if (result.success) {
            Alpine.store('ui').success('{% trans "Appointment saved successfully" %}');
            {% if mode == 'edit' %}
            window.location.href = '/modules/appointments/appointments/{{ appointment.id }}/';
            {% else %}
            window.location.href = '/modules/appointments/appointments/' + result.appointment_id + '/';
            {% endif %}
        } else {
            Alpine.store('ui').error(result.error || '{% trans "Error saving appointment" %}');
            submitBtn.disabled = false;
        }
    } catch (error) {
        console.error('Error:', error);
        Alpine.store('ui').error('{% trans "Error saving appointment" %}');
        submitBtn.disabled = false;
    }
});
</script>

{% component "tabbar" module_id="appointments" current_view="appointments" %}{% endcomponent %}
{% endblock %}
