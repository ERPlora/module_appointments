{% extends "ui/app_base.html" %}
{% load static i18n djicons ui component_tags %}

{% block page_title %}{% trans "Blocked Times" %}{% endblock %}

{% block page_content %}
{% ui_page_header title=_("Blocked Times") %}

<div class="ion-padding">
    {% if blocked_times %}
    {% ui_card %}
        {% ui_list lines="full" %}
            {% for blocked in blocked_times %}
            <ion-item-sliding>
                <ion-item>
                    {% icon "{% if blocked.block_type == 'holiday' %}calendar{% elif blocked.block_type == 'vacation' %}airplane{% elif blocked.block_type == 'break' %}cafe{% elif blocked.block_type == 'maintenance' %}build{% else %}close-circle{% endif %}-outline" css_class="text-danger" %}
                    <ion-label>
                        <h2>{{ blocked.title }}</h2>
                        <p>{{ blocked.start_datetime|date:"d M Y H:i" }} - {{ blocked.end_datetime|date:"d M Y H:i" }}</p>
                        {% if blocked.reason %}
                        <p class="fs-xs text-secondary">{{ blocked.reason }}</p>
                        {% endif %}
                    </ion-label>
                    <ion-badge slot="end" color="{% if blocked.block_type == 'holiday' %}danger{% elif blocked.block_type == 'vacation' %}warning{% else %}medium{% endif %}">
                        {{ blocked.get_block_type_display }}
                    </ion-badge>
                </ion-item>
                <ion-item-options side="end">
                    <ion-item-option color="danger" onclick="deleteBlocked({{ blocked.id }})">
                        {% icon "trash-outline" %}
                    </ion-item-option>
                </ion-item-options>
            </ion-item-sliding>
            {% endfor %}
        {% endui_list %}
    {% endui_card %}
    {% else %}
    {% ui_empty_state title=_("No blocked times") icon="close-circle-outline" description=_("No time periods are currently blocked") %}
    {% endif %}
</div>

<ion-fab vertical="bottom" horizontal="end" slot="fixed">
    <ion-fab-button href="{% url 'appointments:blocked_time_create' %}">
        {% icon "add" %}
    </ion-fab-button>
</ion-fab>

<script>
async function deleteBlocked(id) {
    const alert = document.createElement('ion-alert');
    alert.header = '{% trans "Delete Blocked Time" %}';
    alert.message = '{% trans "Are you sure you want to remove this blocked time?" %}';
    alert.buttons = [
        { text: '{% trans "Cancel" %}', role: 'cancel' },
        {
            text: '{% trans "Delete" %}',
            handler: async () => {
                try {
                    const response = await fetch(`/modules/appointments/blocked/${id}/delete/`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    const result = await response.json();
                    if (result.success) {
                        Alpine.store('ui').success('{% trans "Blocked time removed" %}');
                        location.reload();
                    } else {
                        Alpine.store('ui').error(result.error);
                    }
                } catch (e) {
                    Alpine.store('ui').error('{% trans "Error removing blocked time" %}');
                }
            }
        }
    ];
    document.body.appendChild(alert);
    alert.present();
}
</script>

{% component "tabbar" module_id="appointments" current_view="calendar" %}{% endcomponent %}
{% endblock %}
