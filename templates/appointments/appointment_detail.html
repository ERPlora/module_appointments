{% extends "ui/app_base.html" %}
{% load static i18n djicons ui component_tags %}

{% block page_title %}{{ appointment.appointment_number }}{% endblock %}

{% block page_content %}
{% ui_page_header title=appointment.appointment_number %}

<div class="ion-padding">
    {# Status & Actions #}
    {% ui_card css_class="mb-lg" %}
        <div class="d-flex justify-between align-center">
            <div>
                <ion-badge color="{% if appointment.status == 'confirmed' %}primary{% elif appointment.status == 'pending' %}warning{% elif appointment.status == 'completed' %}success{% elif appointment.status == 'cancelled' %}medium{% elif appointment.status == 'no_show' %}danger{% else %}medium{% endif %}" style="font-size: 1rem; padding: 0.5rem 1rem;">
                    {{ appointment.get_status_display }}
                </ion-badge>
            </div>
            <div class="d-flex gap-sm">
                {% if appointment.status == 'pending' %}
                <ion-button fill="outline" color="success" onclick="confirmAppointment()">
                    {% icon "checkmark-outline" %}
                    {% trans "Confirm" %}
                </ion-button>
                {% endif %}

                {% if appointment.status == 'confirmed' %}
                <ion-button fill="outline" color="primary" onclick="startAppointment()">
                    {% icon "play-outline" %}
                    {% trans "Start" %}
                </ion-button>
                {% endif %}

                {% if appointment.status == 'in_progress' %}
                <ion-button color="success" onclick="completeAppointment()">
                    {% icon "checkmark-circle-outline" %}
                    {% trans "Complete" %}
                </ion-button>
                {% endif %}

                {% if appointment.can_cancel %}
                <ion-button fill="outline" color="danger" onclick="cancelAppointment()">
                    {% icon "close-outline" %}
                    {% trans "Cancel" %}
                </ion-button>
                {% endif %}

                {% if appointment.is_past and appointment.status in 'pending,confirmed' %}
                <ion-button fill="outline" color="warning" onclick="markNoShow()">
                    {% icon "person-remove-outline" %}
                    {% trans "No Show" %}
                </ion-button>
                {% endif %}
            </div>
        </div>
    {% endui_card %}

    {# Customer Info #}
    {% ui_card css_class="mb-lg" %}
        <div class="fw-semibold fs-lg mb-md">{% trans "Customer" %}</div>
        <div class="ui-grid ui-grid--2 gap-md">
            <div>
                <p class="fs-sm text-secondary mb-xs">{% trans "Name" %}</p>
                <p class="fw-semibold">{{ appointment.customer_name }}</p>
            </div>
            {% if appointment.customer_phone %}
            <div>
                <p class="fs-sm text-secondary mb-xs">{% trans "Phone" %}</p>
                <p class="fw-semibold">
                    <a href="tel:{{ appointment.customer_phone }}">{{ appointment.customer_phone }}</a>
                </p>
            </div>
            {% endif %}
            {% if appointment.customer_email %}
            <div>
                <p class="fs-sm text-secondary mb-xs">{% trans "Email" %}</p>
                <p class="fw-semibold">
                    <a href="mailto:{{ appointment.customer_email }}">{{ appointment.customer_email }}</a>
                </p>
            </div>
            {% endif %}
        </div>
    {% endui_card %}

    {# Appointment Details #}
    {% ui_card css_class="mb-lg" %}
        <div class="fw-semibold fs-lg mb-md">{% trans "Appointment Details" %}</div>
        <div class="ui-grid ui-grid--2 gap-md">
            <div>
                <p class="fs-sm text-secondary mb-xs">{% trans "Date" %}</p>
                <p class="fw-semibold">{{ appointment.start_datetime|date:"l, d M Y" }}</p>
            </div>
            <div>
                <p class="fs-sm text-secondary mb-xs">{% trans "Time" %}</p>
                <p class="fw-semibold">{{ appointment.start_datetime|time:"H:i" }} - {{ appointment.end_datetime|time:"H:i" }}</p>
            </div>
            <div>
                <p class="fs-sm text-secondary mb-xs">{% trans "Service" %}</p>
                <p class="fw-semibold">{{ appointment.service_name }}</p>
            </div>
            <div>
                <p class="fs-sm text-secondary mb-xs">{% trans "Duration" %}</p>
                <p class="fw-semibold">{{ appointment.duration_minutes }} {% trans "minutes" %}</p>
            </div>
            <div>
                <p class="fs-sm text-secondary mb-xs">{% trans "Price" %}</p>
                <p class="fw-semibold">{{ appointment.service_price }}</p>
            </div>
            {% if appointment.staff_name %}
            <div>
                <p class="fs-sm text-secondary mb-xs">{% trans "Staff" %}</p>
                <p class="fw-semibold">{{ appointment.staff_name }}</p>
            </div>
            {% endif %}
        </div>
    {% endui_card %}

    {# Notes #}
    {% if appointment.notes or appointment.internal_notes %}
    {% ui_card css_class="mb-lg" %}
        <div class="fw-semibold fs-lg mb-md">{% trans "Notes" %}</div>
        {% if appointment.notes %}
        <div class="mb-md">
            <p class="fs-sm text-secondary mb-xs">{% trans "Customer Notes" %}</p>
            <p>{{ appointment.notes }}</p>
        </div>
        {% endif %}
        {% if appointment.internal_notes %}
        <div>
            <p class="fs-sm text-secondary mb-xs">{% trans "Internal Notes" %}</p>
            <p>{{ appointment.internal_notes }}</p>
        </div>
        {% endif %}
    {% endui_card %}
    {% endif %}

    {# History #}
    {% if history %}
    {% ui_card %}
        <div class="fw-semibold fs-lg mb-md">{% trans "History" %}</div>
        {% ui_list lines="full" %}
            {% for entry in history %}
            <ion-item>
                {% icon "{% if entry.action == 'created' %}add-circle-outline{% elif entry.action == 'confirmed' %}checkmark-circle-outline{% elif entry.action == 'cancelled' %}close-circle-outline{% elif entry.action == 'completed' %}checkmark-done-outline{% elif entry.action == 'rescheduled' %}calendar-outline{% else %}ellipse-outline{% endif %}" css_class="text-{% if entry.action == 'cancelled' or entry.action == 'no_show' %}danger{% elif entry.action == 'completed' %}success{% else %}primary{% endif %}" %}
                <ion-label>
                    <h3>{{ entry.get_action_display }}</h3>
                    <p>{{ entry.description }}</p>
                    <p class="fs-xs text-secondary">{{ entry.created_at|date:"d/m/Y H:i" }}</p>
                </ion-label>
            </ion-item>
            {% endfor %}
        {% endui_list %}
    {% endui_card %}
    {% endif %}

    {# Edit Button #}
    {% if appointment.status in 'pending,confirmed' %}
    <div class="mt-lg">
        <ion-button expand="block" fill="outline" href="{% url 'appointments:appointment_edit' appointment.id %}">
            {% icon "create-outline" %}
            {% trans "Edit Appointment" %}
        </ion-button>
    </div>
    {% endif %}
</div>

<script>
async function confirmAppointment() {
    try {
        const response = await fetch('{% url "appointments:appointment_confirm" appointment.id %}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        const data = await response.json();
        if (data.success) {
            Alpine.store('ui').success('{% trans "Appointment confirmed" %}');
            location.reload();
        } else {
            Alpine.store('ui').error(data.error);
        }
    } catch (e) {
        Alpine.store('ui').error('{% trans "Error confirming appointment" %}');
    }
}

async function startAppointment() {
    try {
        const response = await fetch('{% url "appointments:appointment_complete" appointment.id %}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        const data = await response.json();
        if (data.success) {
            Alpine.store('ui').success('{% trans "Appointment started" %}');
            location.reload();
        }
    } catch (e) {
        Alpine.store('ui').error('{% trans "Error starting appointment" %}');
    }
}

async function completeAppointment() {
    try {
        const response = await fetch('{% url "appointments:appointment_complete" appointment.id %}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        const data = await response.json();
        if (data.success) {
            Alpine.store('ui').success('{% trans "Appointment completed" %}');
            location.reload();
        } else {
            Alpine.store('ui').error(data.error);
        }
    } catch (e) {
        Alpine.store('ui').error('{% trans "Error completing appointment" %}');
    }
}

async function cancelAppointment() {
    const alert = document.createElement('ion-alert');
    alert.header = '{% trans "Cancel Appointment" %}';
    alert.message = '{% trans "Are you sure you want to cancel this appointment?" %}';
    alert.inputs = [
        {
            name: 'reason',
            type: 'textarea',
            placeholder: '{% trans "Cancellation reason (optional)" %}'
        }
    ];
    alert.buttons = [
        { text: '{% trans "No" %}', role: 'cancel' },
        {
            text: '{% trans "Yes, Cancel" %}',
            handler: async (data) => {
                try {
                    const response = await fetch('{% url "appointments:appointment_cancel" appointment.id %}', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ reason: data.reason })
                    });
                    const result = await response.json();
                    if (result.success) {
                        Alpine.store('ui').success('{% trans "Appointment cancelled" %}');
                        location.reload();
                    } else {
                        Alpine.store('ui').error(result.error);
                    }
                } catch (e) {
                    Alpine.store('ui').error('{% trans "Error cancelling appointment" %}');
                }
            }
        }
    ];
    document.body.appendChild(alert);
    await alert.present();
}

async function markNoShow() {
    try {
        const response = await fetch('{% url "appointments:appointment_no_show" appointment.id %}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        const data = await response.json();
        if (data.success) {
            Alpine.store('ui').success('{% trans "Marked as no-show" %}');
            location.reload();
        } else {
            Alpine.store('ui').error(data.error);
        }
    } catch (e) {
        Alpine.store('ui').error('{% trans "Error marking no-show" %}');
    }
}
</script>

{% component "tabbar" module_id="appointments" current_view="appointments" %}{% endcomponent %}
{% endblock %}
